<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architecture Canvas</title>
    <style>
        #container {
            display: flex;
            align-content: center;
            justify-content: center;
        }

        .layer {
            fill-opacity: 0.3;
        }

        .component:hover, .component.highlight {
            stroke: black;
            stroke-opacity: 0.3;
            stroke-width: 3px;
        }

        .components-container {
            max-width: 50vw;
            display: flex;
        }

        .components {
            font-family: sans-serif;
            font-size: 14px;
            cursor: pointer;
            padding: 24px;
            width: 300px;
        }

        .components .title {
            font-weight: bold;
        }

        .components .component-id:hover {
            font-weight: bold;
        }

        .components .component-id.highlight {
            font-weight: bold;
        }
    </style>
</head>
<body>
<div id="container"></div>

<script type="module">
    import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

    class Components {
        constructor(layers, containerSelector) {
            this.layers = layers
            this.containerSelector = containerSelector
        }

        render() {
            const container = d3.select(this.containerSelector)
                .append("div")
                .attr("class", "components-container");

            this.layers.reverse().forEach(layer => {
                const list = container
                    .append("div")
                    .attr("class", "components");

                this.renderTitle(list, layer)

                layer.components.forEach(component => {
                    this.renderComponent(list, layer, component)
                });
            });
        }

        renderTitle(list, layer) {
            list.append("div")
                .attr("class", "title")
                .style("color", layer.colour)
                .text(layer.id)
        }

        renderComponent(list, layer, component) {
            list.append("div")
                .attr("id", `text-${component.id}`)
                .attr("class", "component-id")
                .style("color", component.shared ? "lightgray" : layer.colour)
                .text(component.id)
                .on("mouseover", function () {
                    d3.select(`#comp-${component.id}`).classed("highlight", true);
                })
                .on("mouseout", function () {
                    d3.select(`#comp-${component.id}`).classed("highlight", false);
                });
        }
    }

    class BubbleChart {
        constructor(layers, containerSelector, width, height) {
            this.width = width;
            this.height = height;
            this.containerSelector = containerSelector;
            this.layers = layers;
        }

        render() {
            const svg = d3.select(this.containerSelector)
                .append("svg")
                .attr("width", this.width)
                .attr("height", this.height);

            const packedLayers = this.packLayers(this.layers)

            const group = svg.selectAll("g")
                .data(packedLayers)
                .enter()
                .append("g")
                .attr("transform", d => `translate(${d.x},${d.y})`);

            const allBubbles = group.append("circle")
                .attr("r", d => d.r)

            const componentBubbles = allBubbles.filter(d => !d.children)
            const layerBubbles = allBubbles.filter(d => d.children)

            layerBubbles
                .attr("fill", d => d.data.colour)
                .attr("fill-opacity", 0.3)

            componentBubbles
                .attr("class", "component")
                .attr("id", d => `comp-${d.data.id}`)
                .attr("fill", d => d.parent.data.colour)
                .attr("fill-opacity", 1)
                .on("mouseover", function (e, d) {
                    d3.select(`#text-${d.data.id}`).classed("highlight", true);
                })
                .on("mouseout", function (e, d) {
                    d3.select(`#text-${d.data.id}`).classed("highlight", false);
                });
        }

        packLayers(layers) {
            const packer = d3.pack()
                .size([this.width, this.height])
                .padding(10);

            const root = d3.hierarchy(this.computeHierarchy(layers))
                .sum(d => d.weight)
                .sort((a, b) => b.value - a.value); // TODO: figure out how to show the packing from bottom-up rather than left-to-right

            return packer(root).descendants()
        }

        computeHierarchy(layers) {
            const infra = layers.find(it => it.id === "Infrastructure")
            const useCases = layers.find(it => it.id === "Use Cases")
            const domain = layers.find(it => it.id === "Domain")
            return {
                id: infra.id,
                colour: infra.colour,
                weight: 1,
                children: [
                    ...infra.components.map(component => ({
                        id: component.id,
                        shared: component.shared,
                        weight: this.randomWeight(), // TODO: should be reflecting the complexity of the component
                    })),
                    {
                        id: useCases.id,
                        colour: useCases.colour,
                        weight: 1,
                        children: [
                            ...useCases.components.map(component => ({
                                id: component.id,
                                shared: component.shared,
                                weight: this.randomWeight(), // TODO: should be reflecting the complexity of the component
                            })),
                            {
                                id: domain.id,
                                colour: domain.colour,
                                weight: 1,
                                children: domain.components.map(component => ({
                                    id: component.id,
                                    shared: component.shared,
                                    weight: this.randomWeight(), // TODO: should be reflecting the complexity of the component
                                }))
                            }
                        ]
                    }
                ]
            };
        }

        randomWeight() {
            return (Math.random() * 100) + 10;
        }
    }

    const layersData = {{data}};

    new BubbleChart(layersData, "#container", 460, 460).render()
    new Components(layersData, "#container").render()
</script>
</body>
</html>